<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VLAMy OCR - Vision Language Assistant for My Documents</title>
    
    <!-- CSS Framework and Custom Styles -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="/static/css/app.css" rel="stylesheet">
    
    <!-- Fabric.js for image annotation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.0/fabric.min.js"></script>
    <!-- JSZip for ZIP file handling in browser cache mode -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container-fluid">
            <a class="navbar-brand" href="/">
                <i class="fas fa-eye me-2"></i>VLAMy OCR
            </a>
            
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="#" onclick="showProjects()">
                            <i class="fas fa-folder me-1"></i>Projects
                        </a>
                    </li>
                    <li class="nav-item" id="serverExportsNav">
                        <a class="nav-link" href="#" onclick="showExports()">
                            <i class="fas fa-download me-1"></i>Exports
                        </a>
                    </li>
                    <li class="nav-item" id="serverImportsNav">
                        <a class="nav-link" href="#" onclick="showImports()">
                            <i class="fas fa-upload me-1"></i>Import
                        </a>
                    </li>
                    <li class="nav-item" id="browserCacheDataNav" style="display: none;">
                        <a class="nav-link" href="#" onclick="app.showBrowserCacheExportModal()">
                            <i class="fas fa-database me-1"></i>Browser Data
                        </a>
                    </li>
                </ul>
                
                <ul class="navbar-nav">
                    <li class="nav-item dropdown" id="userMenu" style="display: none;">
                        <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown">
                            <i class="fas fa-user me-1"></i><span id="username"></span>
                        </a>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="#" onclick="showCredentialsModal()">
                                <i class="fas fa-key me-2"></i>API Credentials
                            </a></li>
                            <li id="browserCacheExitOption" style="display: none;"><a class="dropdown-item" href="#" onclick="app.exitBrowserCacheMode()">
                                <i class="fas fa-times me-2"></i>Exit Browser Cache Mode
                            </a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li id="logoutOption"><a class="dropdown-item" href="#" onclick="logout()">
                                <i class="fas fa-sign-out-alt me-2"></i>Logout
                            </a></li>
                        </ul>
                    </li>
                    <li class="nav-item" id="loginButton">
                        <a class="nav-link" href="#" onclick="showLogin()">
                            <i class="fas fa-sign-in-alt me-1"></i>Login
                        </a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="container-fluid p-0">
        <!-- Loading Spinner -->
        <div id="loadingSpinner" class="d-flex justify-content-center align-items-center position-fixed w-100 h-100" style="top: 0; left: 0; background: rgba(0,0,0,0.5); z-index: 9999; display: none !important;">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
        </div>

        <!-- Welcome Screen -->
        <div id="welcomeScreen" class="container py-5">
            <div class="row justify-content-center">
                <div class="col-lg-8 text-center">
                    <h1 class="display-4 mb-4">
                        <i class="fas fa-eye text-primary"></i>
                        VLAMy OCR
                    </h1>
                    <p class="lead mb-4">
                        Vision Language Assistant for Document Transcription and Analysis
                    </p>
                    <p class="mb-4">
                        Upload images, draw annotations, and transcribe text using OpenAI or custom OCR endpoints.
                        Organize your work with projects and documents, share with collaborators, and export your data.
                    </p>
                    
                    <div class="row g-4 mt-4">
                        <div class="col-md-4">
                            <div class="card h-100">
                                <div class="card-body text-center">
                                    <i class="fas fa-upload fa-3x text-primary mb-3"></i>
                                    <h5>Upload Images</h5>
                                    <p class="text-muted">Upload documents, photos, or any images containing text</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card h-100">
                                <div class="card-body text-center">
                                    <i class="fas fa-draw-polygon fa-3x text-primary mb-3"></i>
                                    <h5>Annotate Regions</h5>
                                    <p class="text-muted">Draw bounding boxes or polygons around text regions</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card h-100">
                                <div class="card-body text-center">
                                    <i class="fas fa-robot fa-3x text-primary mb-3"></i>
                                    <h5>AI Transcription</h5>
                                    <p class="text-muted">Use OpenAI or custom endpoints to transcribe text</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mt-5">
                        <button class="btn btn-primary btn-lg me-3" onclick="showRegister()">
                            <i class="fas fa-user-plus me-2"></i>Get Started
                        </button>
                        <button class="btn btn-outline-primary btn-lg me-3" onclick="showLogin()">
                            <i class="fas fa-sign-in-alt me-2"></i>Sign In
                        </button>
                        <button class="btn btn-success btn-lg" onclick="app.startBrowserCacheMode()">
                            <i class="fas fa-database me-2"></i>Use Browser Cache
                        </button>
                    </div>
                    
                    <div class="mt-4 text-center">
                        <div class="alert alert-info d-inline-block">
                            <i class="fas fa-info-circle me-2"></i>
                            <strong>Browser Cache Mode:</strong> Use all features without an account. Data is stored locally in your browser.
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Login Form -->
        <div id="loginScreen" class="container py-5" style="display: none;">
            <div class="row justify-content-center">
                <div class="col-md-6 col-lg-4">
                    <div class="card">
                        <div class="card-header text-center">
                            <h4><i class="fas fa-sign-in-alt me-2"></i>Sign In</h4>
                        </div>
                        <div class="card-body">
                            <form id="loginForm" onsubmit="login(event)">
                                <div class="mb-3">
                                    <label for="loginUsername" class="form-label">Username</label>
                                    <input type="text" class="form-control" id="loginUsername" required>
                                </div>
                                <div class="mb-3">
                                    <label for="loginPassword" class="form-label">Password</label>
                                    <input type="password" class="form-control" id="loginPassword" required>
                                </div>
                                <button type="submit" class="btn btn-primary w-100">
                                    <i class="fas fa-sign-in-alt me-2"></i>Sign In
                                </button>
                            </form>
                            <div class="text-center mt-3">
                                <a href="#" onclick="showRegister()">Don't have an account? Register</a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Registration Form -->
        <div id="registerScreen" class="container py-5" style="display: none;">
            <div class="row justify-content-center">
                <div class="col-md-8 col-lg-6">
                    <div class="card">
                        <div class="card-header text-center">
                            <h4><i class="fas fa-user-plus me-2"></i>Request Account</h4>
                        </div>
                        <div class="card-body">
                            <div class="alert alert-info">
                                <i class="fas fa-info-circle me-2"></i>
                                Account requests require admin approval. You'll be notified when your account is ready.
                            </div>
                            <form id="registerForm" onsubmit="register(event)">
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label for="regFirstName" class="form-label">First Name</label>
                                        <input type="text" class="form-control" id="regFirstName" required>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label for="regLastName" class="form-label">Last Name</label>
                                        <input type="text" class="form-control" id="regLastName" required>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <label for="regUsername" class="form-label">Username</label>
                                    <input type="text" class="form-control" id="regUsername" required>
                                </div>
                                <div class="mb-3">
                                    <label for="regEmail" class="form-label">Email</label>
                                    <input type="email" class="form-control" id="regEmail" required>
                                </div>
                                <div class="mb-3">
                                    <label for="regPassword" class="form-label">Password</label>
                                    <input type="password" class="form-control" id="regPassword" required>
                                </div>
                                <div class="mb-3">
                                    <label for="regPasswordConfirm" class="form-label">Confirm Password</label>
                                    <input type="password" class="form-control" id="regPasswordConfirm" required>
                                </div>
                                <button type="submit" class="btn btn-primary w-100">
                                    <i class="fas fa-user-plus me-2"></i>Request Account
                                </button>
                            </form>
                            <div class="text-center mt-3">
                                <a href="#" onclick="showLogin()">Already have an account? Sign In</a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Application Interface -->
        <div id="appInterface" style="display: none;">
            <!-- Sidebar -->
            <div class="row g-0" id="mainAppContainer">
                <div class="col-md-3 bg-light border-end" id="leftSidebar">
                    <!-- Left Panel Collapse Button -->
                    <div class="panel-collapse-btn left-panel-btn" onclick="toggleLeftPanel()">
                        <i class="fas fa-chevron-left" id="leftPanelIcon"></i>
                    </div>
                    
                    <div class="sidebar p-3">
                        <!-- API Credentials Setup -->
                        <div class="card mb-3" id="credentialsCard">
                            <div class="card-header">
                                <h6 class="mb-0">
                                    <i class="fas fa-key me-2"></i>API Credentials
                                    <span class="badge bg-warning ms-2" id="credentialsStatus">Not Set</span>
                                </h6>
                            </div>
                            <div class="card-body">
                                <button class="btn btn-outline-primary btn-sm w-100" onclick="showCredentialsModal()">
                                    <i class="fas fa-cog me-2"></i>Configure
                                </button>
                            </div>
                        </div>

                        <!-- Project Tree -->
                        <div class="card">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h6 class="mb-0">
                                    <i class="fas fa-folder me-2"></i>Projects
                                </h6>
                                <div class="btn-group">
                                    <button class="btn btn-outline-primary btn-sm" onclick="showCreateProjectModal()">
                                        <i class="fas fa-plus"></i>
                                    </button>
                                    <button class="btn btn-outline-info btn-sm" onclick="showIIIFImportModal()">
                                        <i class="fas fa-globe"></i>
                                    </button>
                                    <button class="btn btn-outline-danger btn-sm" onclick="toggleBulkSelect()" id="bulkSelectBtn">
                                        <i class="fas fa-check-square"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="card-body p-0">
                                <!-- Bulk Actions Bar -->
                                <div id="bulkActionsBar" class="bulk-actions-bar p-2 bg-light border-bottom" style="display: none;">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <span id="selectedCount">0 selected</span>
                                        <div class="btn-group btn-group-sm">
                                            <button class="btn btn-outline-danger" onclick="bulkDeleteSelected()">
                                                <i class="fas fa-trash me-1"></i>Delete Selected
                                            </button>
                                            <button class="btn btn-outline-secondary" onclick="clearSelection()">
                                                <i class="fas fa-times me-1"></i>Clear
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                <div id="projectTree" class="tree-view">
                            <!-- Projects will be loaded here -->
                        </div>
                        
                        <!-- Annotation Types Configuration -->
                        <div class="sidebar-section mt-4">
                            <h6 class="sidebar-section-title text-center">
                                <i class="fas fa-cog me-2"></i>ANNOTATION TYPES
                            </h6>
                            <div class="annotation-types-config">
                                <!-- Custom Zones Toggle -->
                                <div class="custom-zones-toggle">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="enableCustomZones" 
                                               onchange="app.toggleCustomZones(this.checked)">
                                        <label class="form-check-label" for="enableCustomZones">
                                            <i class="fas fa-layer-group me-2"></i>Enable Custom Zones
                                        </label>
                                    </div>
                                </div>
                                <div class="config-checklist" id="annotationTypesChecklist">
                                    <!-- Annotation types will be populated by JavaScript -->
                                </div>
                            </div>
                        </div>
                        
                        <!-- Prompts Section -->
                        <div class="sidebar-section mt-4">
                            <h6 class="sidebar-section-title text-center">
                                <i class="fas fa-comment-dots me-2"></i>PROMPTS
                                <button class="btn btn-xs btn-outline-primary ms-2" onclick="showAddPromptModal()">
                                    <i class="fas fa-plus"></i>
                                </button>
                            </h6>
                            <div id="promptsList" class="prompts-list">
                                <!-- Prompts will be loaded here -->
                            </div>
                            
                            <!-- Detection Mapper Collapsible Section -->
                            <div class="mt-3">
                                <div class="d-flex align-items-center justify-content-between p-2 bg-light border rounded cursor-pointer" 
                                     onclick="toggleDetectionMapper()" style="cursor: pointer;">
                                    <small class="fw-bold text-muted">
                                        <i class="fas fa-map me-1"></i>DETECTION MAPPER
                                    </small>
                                    <i class="fas fa-chevron-down" id="mapperChevron"></i>
                                </div>
                                <div id="detectionMapperContent" class="border border-top-0 p-2" style="display: none;">
                                    <small class="text-muted d-block mb-2">
                                        Map detection classes to your zones:
                                    </small>
                                    <div id="detectionMappingsList" class="mb-2">
                                        <!-- Existing mappings will be loaded here -->
                                    </div>
                                    <div class="input-group input-group-sm">
                                        <input type="text" class="form-control" id="newDetectionClass" 
                                               placeholder="Detection class" style="font-size: 11px;">
                                        <select class="form-select" id="newMappingTarget" style="font-size: 11px;">
                                            <option value="">Select zone...</option>
                                            <!-- Options will be populated by JS -->
                                        </select>
                                        <button class="btn btn-outline-primary btn-sm" onclick="addDetectionMapping()">
                                            <i class="fas fa-plus"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Left Resize Handle -->
                <div class="resize-handle left-resize" id="leftResizeHandle"></div>

                <!-- Main Content Area -->
                <div class="col-md-9" id="mainContent">
                    <div class="main-content">
                        <!-- Image Viewer and Annotation Tools -->
                        <div id="imageViewer" style="display: none;">
                            <div class="toolbar bg-light p-2 border-bottom">
                                <div class="btn-group me-3" role="group">
                                    <button class="btn btn-outline-secondary active" id="selectTool" onclick="setTool('select')">
                                        <i class="fas fa-mouse-pointer"></i>
                                    </button>
                                    <button class="btn btn-outline-secondary" id="bboxTool" onclick="setTool('bbox')">
                                        <i class="fas fa-square"></i>
                                    </button>
                                    <button class="btn btn-outline-secondary" id="polygonTool" onclick="setTool('polygon')">
                                        <i class="fas fa-draw-polygon"></i>
                                    </button>
                                </div>
                                
                                <!-- Classification Selector (shown when bbox tool is active) -->
                                <div class="annotation-classification me-3" id="classificationSelector" style="display: none;">
                                    <label class="form-label small me-2 mb-0">Classification:</label>
                                    <select class="form-select form-select-sm" id="annotationClassification" style="width: auto;">
                                        <option value="">No classification</option>
                                        <!-- Options will be populated by JavaScript -->
                                    </select>
                                </div>
                                
                                <div class="btn-group me-3" role="group">
                                    <button class="btn btn-outline-primary" onclick="transcribeFullImage()">
                                        <i class="fas fa-robot me-1"></i>Transcribe Image
                                    </button>
                                    <button class="btn btn-outline-success" onclick="transcribeSelectedAnnotations()">
                                        <i class="fas fa-magic me-1"></i>Transcribe Selected
                                    </button>
                                    <button class="btn btn-outline-warning" onclick="transcribeAllRegions()">
                                        <i class="fas fa-layer-group me-1"></i>Transcribe All Regions
                                    </button>
                                </div>
                                
                                <!-- Model Selection -->
                                <div class="model-selection me-3">
                                    <label class="form-label small me-2 mb-0">Model:</label>
                                    <select class="form-select form-select-sm" id="transcriptionModel" style="width: auto;">
                                        <!-- Options will be populated by JavaScript -->
                                    </select>
                                </div>
                                
                                <div class="btn-group me-3" role="group">
                                    <button class="btn btn-outline-info" onclick="showDetectZonesLinesModal()" id="detectZonesLinesBtn">
                                        <i class="fas fa-search-location me-1"></i>Detect Zones/Lines
                                    </button>
                                </div>
                                
                                <div class="btn-group" role="group">
                                    <button class="btn btn-outline-secondary" onclick="zoomIn()" title="Zoom In">
                                        <i class="fas fa-search-plus"></i>
                                    </button>
                                    <button class="btn btn-outline-secondary" onclick="zoomOut()" title="Zoom Out">
                                        <i class="fas fa-search-minus"></i>
                                    </button>
                                    <button class="btn btn-outline-secondary" onclick="resetZoom()" title="Reset Zoom">
                                        <i class="fas fa-expand-arrows-alt"></i>
                                    </button>
                                    <button class="btn btn-outline-secondary" onclick="fitToScreen()" title="Fit to Screen">
                                        <i class="fas fa-compress-arrows-alt"></i>
                                    </button>
                                </div>
                            </div>
                            
                            <div class="viewer-container d-flex">
                                <div class="canvas-container flex-grow-1">
                                    <canvas id="fabricCanvas"></canvas>
                                </div>
                                
                                <!-- Right Resize Handle -->
                                <div class="resize-handle right-resize" id="rightResizeHandle"></div>
                                
                                <!-- Transcription Panel -->
                                <div class="transcription-panel bg-light p-3" id="transcriptionPanel" style="width: 800px; min-height: 600px; overflow-y: auto;">
                                    <!-- Right Panel Collapse Button -->
                                    <div class="panel-collapse-btn right-panel-btn" onclick="toggleRightPanel()">
                                        <i class="fas fa-chevron-right" id="rightPanelIcon"></i>
                                    </div>
                                    
                                    <h6><i class="fas fa-align-left me-2"></i>Transcription</h6>
                                    <div id="transcriptionContent">
                                        <p class="text-muted">Select an image to view transcription</p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Default View -->
                        <div id="defaultView" class="p-4 text-center">
                            <i class="fas fa-images fa-5x text-muted mb-3"></i>
                            <h4 class="text-muted">Select an image to start annotating</h4>
                            <p class="text-muted">Choose a project and document from the sidebar, then select an image to begin.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <!-- API Credentials Modal -->
    <div class="modal fade" id="credentialsModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-key me-2"></i>API Credentials
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-info">
                        <i class="fas fa-shield-alt me-2"></i>
                        Credentials are stored locally in your browser and never sent to our servers.
                    </div>
                    
                    <div class="row">
                        <div class="col-12 mb-3">
                            <label for="openaiApiKey" class="form-label">OpenAI API Key</label>
                            <input type="password" class="form-control" id="openaiApiKey" placeholder="sk-...">
                            <div class="form-text">Used for GPT-4 Vision transcription</div>
                        </div>
                        
                        <div class="col-12 mb-3">
                            <label for="openaiModel" class="form-label">OpenAI Model</label>
                            <select class="form-control" id="openaiModel">
                                <option value="gpt-4o-mini">GPT-4o Mini</option>
                                <option value="gpt-4o">GPT-4o</option>
                            </select>
                            <div class="form-text">Select the OpenAI model to use for transcription</div>
                        </div>
                        
                        <div class="col-12 mb-3">
                            <label for="customEndpoint" class="form-label">Custom OCR Endpoint</label>
                            <input type="url" class="form-control" id="customEndpoint" placeholder="https://your-api.com/ocr">
                            <div class="form-text">Alternative OCR service endpoint</div>
                        </div>
                        
                        <div class="col-12 mb-3">
                            <label for="customAuth" class="form-label">Custom Endpoint Authorization</label>
                            <input type="password" class="form-control" id="customAuth" placeholder="Bearer token or API key">
                        </div>
                        
                        <hr class="my-4">
                        <h6 class="text-primary mb-3">
                            <i class="fas fa-cloud me-2"></i>Vertex AI (Google Cloud)
                        </h6>
                        
                        <div class="col-12 mb-3">
                            <label for="vertexAccessToken" class="form-label">Access Token</label>
                            <input type="password" class="form-control" id="vertexAccessToken" placeholder="Enter your GCP access token">
                            <div class="form-text">
                                Get token with: <code>gcloud auth print-access-token</code>
                                <br><small class="text-warning"><i class="fas fa-exclamation-triangle me-1"></i>Warning: Token expires after approximately 1 hour</small>
                            </div>
                        </div>
                        
                        <div class="col-12 mb-3">
                            <label for="vertexProjectId" class="form-label">Project ID</label>
                            <input type="text" class="form-control" id="vertexProjectId" placeholder="your-gcp-project-id">
                            <div class="form-text">Enter your Google Cloud project ID</div>
                        </div>
                        
                        <div class="col-12 mb-3">
                            <label for="vertexLocation" class="form-label">Location</label>
                            <select class="form-control" id="vertexLocation">
                                <option value="us-central1">us-central1</option>
                                <option value="us-east1">us-east1</option>
                                <option value="us-west1">us-west1</option>
                                <option value="europe-west1">europe-west1</option>
                            </select>
                            <div class="form-text">Select the Vertex AI region for your project</div>
                        </div>
                        
                        <div class="col-12 mb-3">
                            <label for="vertexModel" class="form-label">Vertex AI Model</label>
                            <select class="form-control" id="vertexModel">
                                <option value="google/gemini-2.0-flash-lite-001">Gemini 2.0 Flash Lite</option>
                                <option value="google/gemini-2.0-flash-001">Gemini 2.0 Flash</option>
                                <option value="google/gemini-2.5-flash-preview-05-20">Gemini 2.5 Flash</option>
                                <option value="google/gemini-2.5-pro-preview-05-20">Gemini 2.5 Pro</option>
                            </select>
                            <div class="form-text">Select the Gemini model to use for transcription</div>
                        </div>
                        
                        <hr class="my-4">
                        <h6 class="text-primary mb-3">
                            <i class="fas fa-search-location me-2"></i>Roboflow Zone/Line Detection
                        </h6>
                        
                        <div class="col-12 mb-3">
                            <label for="roboflowApiKey" class="form-label">Roboflow API Key</label>
                            <input type="password" class="form-control" id="roboflowApiKey" placeholder="Enter your Roboflow API key">
                            <div class="form-text">Required for automatic zone and line detection</div>
                        </div>
                        
                        <div class="col-12 mb-3">
                            <label for="roboflowWorkspace" class="form-label">Workspace Name</label>
                            <input type="text" class="form-control" id="roboflowWorkspace" placeholder="text-regions">
                            <div class="form-text">Enter your Roboflow workspace name</div>
                        </div>
                        
                        <div class="col-12 mb-3">
                            <label for="roboflowWorkflowId" class="form-label">Workflow ID</label>
                            <input type="text" class="form-control" id="roboflowWorkflowId" placeholder="detect-count-and-visualize">
                            <div class="form-text">Enter the specific workflow ID</div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="saveCredentials()">
                        <i class="fas fa-save me-2"></i>Save
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Annotation Modal -->
    <div class="modal fade" id="editAnnotationModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-edit me-2"></i>Edit Annotation
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="editAnnotationForm">
                        <div class="mb-3">
                            <label for="editAnnotationClassification" class="form-label">Classification</label>
                            <select class="form-select" id="editAnnotationClassification">
                                <option value="">No classification</option>
                                <!-- Options will be populated by JavaScript -->
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="editAnnotationLabel" class="form-label">Label</label>
                            <input type="text" class="form-control" id="editAnnotationLabel" placeholder="Optional label">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Metadata</label>
                            <div id="editAnnotationMetadata">
                                <!-- Metadata fields will be populated by JavaScript -->
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="saveAnnotationEdit()">
                        <i class="fas fa-save me-2"></i>Save Changes
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Add/Edit Prompt Modal -->
    <div class="modal fade" id="promptModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="promptModalTitle">
                        <i class="fas fa-comment-dots me-2"></i>Add Prompt
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="promptForm">
                        <div class="mb-3">
                            <label for="promptName" class="form-label">Prompt Name</label>
                            <input type="text" class="form-control" id="promptName" required>
                        </div>
                        <div class="mb-3">
                            <label for="promptText" class="form-label">Prompt Text</label>
                            <textarea class="form-control" id="promptText" rows="4" required 
                                      placeholder="Enter the transcription prompt instructions..."></textarea>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Applicable Zone Types</label>
                            <div class="row" id="promptZoneTypes">
                                <!-- Zone type checkboxes will be populated by JavaScript -->
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Metadata Fields</label>
                            <div id="promptMetadataFields">
                                <!-- Metadata field definitions will be populated by JavaScript -->
                            </div>
                            <button type="button" class="btn btn-sm btn-outline-primary mt-2" onclick="addMetadataField()">
                                <i class="fas fa-plus me-1"></i>Add Metadata Field
                            </button>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="savePrompt()">
                        <i class="fas fa-save me-2"></i>Save Prompt
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Detect Zones/Lines Modal -->
    <div class="modal fade" id="detectZonesLinesModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-search-location me-2"></i>Detect Zones/Lines
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        <strong>Roboflow Detection:</strong> This will automatically detect zones and lines in your image using AI.
                    </div>
                    
                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="filterSelectedTypes">
                            <label class="form-check-label" for="filterSelectedTypes">
                                <strong>Filter by Selected Types Only</strong>
                            </label>
                            <div class="form-text">Only detect zones/lines that are enabled in your annotation types below</div>
                        </div>
                    </div>
                    
                    <div id="detectionFilterOptions" style="display: none;">
                        <div class="row">
                            <div class="col-md-6">
                                <h6 class="text-primary mb-2">Zone Types</h6>
                                <div id="detectionZoneTypes" class="detection-type-list">
                                    <!-- Zone type checkboxes will be populated by JavaScript -->
                                </div>
                            </div>
                            <div class="col-md-6">
                                <h6 class="text-success mb-2">Line Types</h6>
                                <div id="detectionLineTypes" class="detection-type-list">
                                    <!-- Line type checkboxes will be populated by JavaScript -->
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div id="detectionProgress" style="display: none;" class="mt-3">
                        <div class="progress">
                            <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 100%"></div>
                        </div>
                        <div class="text-center mt-2">
                            <small class="text-muted">Detecting zones and lines...</small>
                        </div>
                    </div>
                    
                    <div id="detectionResults" style="display: none;" class="mt-3">
                        <div class="alert alert-success">
                            <i class="fas fa-check-circle me-2"></i>
                            <span id="detectionResultsText">Detection completed successfully!</span>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-info" onclick="startZoneLineDetection()" id="startDetectionBtn">
                        <i class="fas fa-search-location me-2"></i>Start Detection
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Create Project Modal -->
    <div class="modal fade" id="createProjectModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-folder-plus me-2"></i>Create New Project
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="createProjectForm">
                        <div class="mb-3">
                            <label for="projectName" class="form-label">Project Name</label>
                            <input type="text" class="form-control" id="projectName" required>
                        </div>
                        <div class="mb-3">
                            <label for="projectDescription" class="form-label">Description</label>
                            <textarea class="form-control" id="projectDescription" rows="3"></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="createProject()">
                        <i class="fas fa-plus me-2"></i>Create
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Create Document Modal -->
    <div class="modal fade" id="createDocumentModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-file-alt me-2 text-primary"></i>Create New Document
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="createDocumentForm">
                        <div class="mb-3">
                            <label for="documentName" class="form-label">Document Name</label>
                            <input type="text" class="form-control" id="documentName" required>
                        </div>
                        <div class="mb-3">
                            <label for="documentDescription" class="form-label">Description</label>
                            <textarea class="form-control" id="documentDescription" rows="3"></textarea>
                        </div>
                        <div class="mb-3">
                            <label for="documentReadingOrder" class="form-label">Reading Order</label>
                            <select class="form-control" id="documentReadingOrder">
                                <option value="">Use default</option>
                                <option value="top_to_bottom_left_to_right">Top to Bottom, Left to Right</option>
                                <option value="left_to_right_top_to_bottom">Left to Right, Top to Bottom</option>
                                <option value="bottom_to_top_left_to_right">Bottom to Top, Left to Right</option>
                                <option value="right_to_left_top_to_bottom">Right to Left, Top to Bottom</option>
                            </select>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="createDocument()">
                        <i class="fas fa-plus me-2"></i>Create
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Upload Image Modal -->
    <div class="modal fade" id="uploadImageModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-image me-2"></i>Upload Images
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="uploadImageForm" enctype="multipart/form-data">
                        <div class="mb-3">
                            <label for="imageFiles" class="form-label">Select Images</label>
                            <input type="file" class="form-control" id="imageFiles" multiple accept="image/*" required>
                            <div class="form-text">Supported formats: JPG, PNG, TIFF, BMP, GIF</div>
                        </div>
                        <div class="mb-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="autoTranscribe">
                                <label class="form-check-label" for="autoTranscribe">
                                    Auto-transcribe after upload
                                </label>
                            </div>
                        </div>
                        <div id="uploadProgress" style="display: none;">
                            <div class="progress mb-3">
                                <div class="progress-bar" role="progressbar" style="width: 0%"></div>
                            </div>
                            <div id="uploadStatus"></div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="uploadImages()">
                        <i class="fas fa-upload me-2"></i>Upload
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Transcribe All Regions Warning Modal -->
    <div class="modal fade" id="transcribeAllModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-exclamation-triangle text-warning me-2"></i>Transcribe All Regions
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        <strong>Warning:</strong> This will overwrite existing transcriptions for all regions in this image.
                    </div>
                    <p>Are you sure you want to transcribe all <span id="regionCount"></span> regions? This action cannot be undone.</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-warning" onclick="confirmTranscribeAllRegions()">
                        <i class="fas fa-layer-group me-2"></i>Transcribe All
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- IIIF Import Modal -->
    <div class="modal fade" id="iiifImportModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-globe me-2 text-info"></i>Import from IIIF Manifest
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        <strong>IIIF Import:</strong> This will create a new project and document from a IIIF manifest URL, automatically downloading all images.
                    </div>
                    <form id="iiifImportForm">
                        <div class="mb-3">
                            <label for="iiifManifestUrl" class="form-label">IIIF Manifest URL</label>
                            <input type="url" class="form-control" id="iiifManifestUrl" required 
                                   placeholder="https://example.com/manifest.json">
                            <div class="form-text">Enter the URL of a IIIF Presentation API manifest</div>
                        </div>
                        <div class="mb-3">
                            <label for="iiifMaxWidth" class="form-label">Image Resolution</label>
                            <select class="form-control" id="iiifMaxWidth">
                                <option value="800">Small (800px width)</option>
                                <option value="1000" selected>Medium (1000px width)</option>
                                <option value="1500">Large (1500px width)</option>
                                <option value="2000">Extra Large (2000px width)</option>
                                <option value="full">Full Resolution</option>
                            </select>
                            <div class="form-text">Choose the maximum image size to download. Smaller sizes import faster.</div>
                        </div>
                        <div class="mb-3">
                            <h6>Examples:</h6>
                            <div class="list-group">
                                <button type="button" class="list-group-item list-group-item-action" 
                                        onclick="setExampleManifest('https://iiif.io/api/cookbook/recipe/0001-mvm-image/manifest.json')">
                                    <strong>Simple Image Manifest</strong><br>
                                    <small class="text-muted">https://iiif.io/api/cookbook/recipe/0001-mvm-image/manifest.json</small>
                                </button>
                                <button type="button" class="list-group-item list-group-item-action" 
                                        onclick="setExampleManifest('https://collections.library.yale.edu/manifests/32188747')">
                                    <strong>Yale Digital Collections</strong><br>
                                    <small class="text-muted">Stieglitz correspondence from Yale (IIIF 3.0)</small>
                                </button>
                                <button type="button" class="list-group-item list-group-item-action" 
                                        onclick="setExampleManifest('https://iiif.bodleian.ox.ac.uk/iiif/manifest/748a9d50-1acd-4b8d-93b8-26db5c43b6d9.json')">
                                    <strong>Bodleian Library Manuscript</strong><br>
                                    <small class="text-muted">Medieval manuscript example (IIIF 2.0)</small>
                                </button>
                            </div>
                        </div>
                        <div id="iiifImportProgress" style="display: none;">
                            <div class="progress mb-3">
                                <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 100%"></div>
                            </div>
                            <div id="iiifImportStatus">Processing manifest...</div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-info" onclick="importIIIFManifest()">
                        <i class="fas fa-download me-2"></i>Import
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bulk Delete Confirmation Modal -->
    <div class="modal fade" id="bulkDeleteModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-exclamation-triangle text-danger me-2"></i>Confirm Bulk Delete
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        <strong>Warning:</strong> This action cannot be undone.
                    </div>
                    <p>Are you sure you want to delete <span id="bulkDeleteCount"></span> selected items?</p>
                    <div id="bulkDeleteDetails"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-danger" onclick="confirmBulkDelete()">
                        <i class="fas fa-trash me-2"></i>Delete Selected
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Zone Selection Modal -->
    <div class="modal fade" id="zoneSelectionModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-search-location me-2"></i>Select Zone Types to Detect
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        Choose your detection mode and which zone types to detect. Detection mappings will be applied automatically.
                    </div>
                    
                    <!-- Detection Mode Selection -->
                    <div class="mb-4">
                        <h6 class="mb-3">Detection Mode</h6>
                        
                        <div class="zone-detection-mode" onclick="app.selectDetectionMode('auto')">
                            <label class="detection-mode-label">
                                <input type="radio" name="detectionMode" value="auto" class="detection-mode-radio" checked>
                                <i class="fas fa-magic me-2 text-primary"></i>
                                Auto-Detect Everything
                            </label>
                            <div class="detection-mode-description">
                                Let the AI model detect all possible zones and lines, then apply your configured mappings automatically.
                            </div>
                        </div>
                        
                        <div class="zone-detection-mode" onclick="app.selectDetectionMode('selective')">
                            <label class="detection-mode-label">
                                <input type="radio" name="detectionMode" value="selective" class="detection-mode-radio">
                                <i class="fas fa-filter me-2 text-warning"></i>
                                Selective Detection
                            </label>
                            <div class="detection-mode-description">
                                Choose specific zone and line types to detect. Only selected types will be detected.
                            </div>
                        </div>
                    </div>
                    
                    <!-- Zone Type Selection (shown only in selective mode) -->
                    <div id="selectiveOptions" style="display: none;">
                        <div class="row">
                            <div class="col-md-6">
                                <h6 class="text-primary mb-3">
                                    <i class="fas fa-square me-2"></i>Zone Types
                                    <button class="btn btn-xs btn-outline-primary ms-2" onclick="app.toggleAllZoneTypes(true)">All</button>
                                    <button class="btn btn-xs btn-outline-secondary ms-1" onclick="app.toggleAllZoneTypes(false)">None</button>
                                </h6>
                                <div id="zoneSelectionZoneTypes" class="zone-selection-list">
                                    <!-- Zone type checkboxes will be populated by JavaScript -->
                                </div>
                            </div>
                            <div class="col-md-6">
                                <h6 class="text-success mb-3">
                                    <i class="fas fa-minus me-2"></i>Line Types
                                    <button class="btn btn-xs btn-outline-success ms-2" onclick="app.toggleAllLineTypes(true)">All</button>
                                    <button class="btn btn-xs btn-outline-secondary ms-1" onclick="app.toggleAllLineTypes(false)">None</button>
                                </h6>
                                <div id="zoneSelectionLineTypes" class="zone-selection-list">
                                    <!-- Line type checkboxes will be populated by JavaScript -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="app.startSelectedZoneDetection()" id="startSelectedDetectionBtn">
                        <i class="fas fa-search-location me-2"></i>Start Detection
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Progress Tracking Modal -->
    <div class="modal fade" id="progressModal" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="progressModalTitle">
                        <i class="fas fa-cog fa-spin me-2"></i>Processing...
                    </h5>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <span id="progressMainLabel">Overall Progress</span>
                            <span id="progressMainStats">0 / 0</span>
                        </div>
                        <div class="progress mb-2">
                            <div class="progress-bar" role="progressbar" style="width: 0%" id="progressMainBar"></div>
                        </div>
                        <small class="text-muted" id="progressCurrentTask">Initializing...</small>
                    </div>
                    
                    <div id="progressDetails" class="border rounded p-3" style="max-height: 300px; overflow-y: auto; background-color: #f8f9fa;">
                        <!-- Progress details will be populated here -->
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="app.cancelOperation()" id="progressCancelBtn">Cancel Operation</button>
                    <button type="button" class="btn btn-primary" data-bs-dismiss="modal" style="display: none;" id="progressCloseBtn">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Transcription Zone Selection Modal -->
    <div class="modal fade" id="transcriptionZoneSelectionModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="transcriptionZoneSelectionTitle">
                        <i class="fas fa-robot me-2"></i>Select Zone Types to Transcribe
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        Choose which zone types to transcribe. Only annotations of the selected types will be processed.
                    </div>
                    
                    <!-- Zone Type Selection -->
                    <div class="row">
                        <div class="col-md-6">
                            <h6 class="text-primary mb-3">
                                <i class="fas fa-square me-2"></i>Zone Types
                                <button class="btn btn-xs btn-outline-primary ms-2" onclick="toggleAllTranscriptionZoneTypes(true)">All</button>
                                <button class="btn btn-xs btn-outline-secondary ms-1" onclick="toggleAllTranscriptionZoneTypes(false)">None</button>
                            </h6>
                            <div id="transcriptionZoneSelectionZoneTypes" class="zone-selection-list">
                                <!-- Zone type checkboxes will be populated by JavaScript -->
                            </div>
                        </div>
                        <div class="col-md-6">
                            <h6 class="text-success mb-3">
                                <i class="fas fa-minus me-2"></i>Line Types
                                <button class="btn btn-xs btn-outline-success ms-2" onclick="toggleAllTranscriptionLineTypes(true)">All</button>
                                <button class="btn btn-xs btn-outline-secondary ms-1" onclick="toggleAllTranscriptionLineTypes(false)">None</button>
                            </h6>
                            <div id="transcriptionZoneSelectionLineTypes" class="zone-selection-list">
                                <!-- Line type checkboxes will be populated by JavaScript -->
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-success" onclick="startSelectedZoneTranscription()">
                        <i class="fas fa-robot me-2"></i>Start Transcription
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Export Projects Modal -->
    <div class="modal fade" id="exportProjectsModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-download me-2 text-success"></i>Export Projects
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        <strong>VLAMy Format:</strong> Export includes original images, PageXML files, and JSON metadata in the standard VLAMy export structure.
                    </div>
                    
                    <form id="exportProjectsForm">
                        <div class="mb-3">
                            <label class="form-label">Export Format</label>
                            <select class="form-select" id="exportFormat">
                                <option value="vlamy" selected>VLAMy Format (ZIP with images + PageXML)</option>
                                <option value="json">JSON Format (metadata only)</option>
                                <option value="pagexml">PageXML Format (ZIP)</option>
                            </select>
                                                            <div class="form-text">VLAMy format includes images, PageXML, and metadata in the standard structure.</div>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Select Projects to Export</label>
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <small class="text-muted">Choose which projects to include in your export</small>
                                <div>
                                    <button type="button" class="btn btn-sm btn-outline-primary" onclick="selectAllProjects()">
                                        <i class="fas fa-check-square me-1"></i>Select All
                                    </button>
                                    <button type="button" class="btn btn-sm btn-outline-secondary" onclick="clearAllProjects()">
                                        <i class="fas fa-square me-1"></i>Clear All
                                    </button>
                                </div>
                            </div>
                            <div id="exportProjectsList" class="border rounded p-3" style="max-height: 300px; overflow-y: auto;">
                                <!-- Projects will be loaded here -->
                                <div class="text-center text-muted p-3">
                                    <i class="fas fa-spinner fa-spin me-2"></i>Loading projects...
                                </div>
                            </div>
                        </div>
                        
                        <div id="exportProgress" style="display: none;">
                            <div class="progress mb-3">
                                <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 100%"></div>
                            </div>
                            <div id="exportStatus">Preparing export...</div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-success" onclick="startExport()" id="exportButton">
                        <i class="fas fa-download me-2"></i>Export Selected Projects
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Export Status Modal -->
    <div class="modal fade" id="exportStatusModal" tabindex="-1" data-bs-backdrop="static">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-download me-2 text-info"></i>Export Status
                    </h5>
                </div>
                <div class="modal-body">
                    <div class="d-flex align-items-center mb-3">
                        <div class="spinner-border spinner-border-sm text-primary me-3" role="status" id="exportSpinner">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <div>
                            <div id="exportStatusText">Processing your export...</div>
                            <small class="text-muted" id="exportStatusDetail">This may take a few minutes for large projects.</small>
                        </div>
                    </div>
                    <div id="exportResult" style="display: none;">
                        <div class="alert alert-success">
                            <i class="fas fa-check-circle me-2"></i>
                            Export completed successfully!
                        </div>
                        <div class="d-grid">
                            <button class="btn btn-success" onclick="downloadExportFile()" id="downloadButton">
                                <i class="fas fa-download me-2"></i>Download Export
                            </button>
                        </div>
                    </div>
                    <div id="exportError" style="display: none;">
                        <div class="alert alert-danger">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            <span id="exportErrorMessage">Export failed</span>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" id="exportCloseButton">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Import Projects Modal -->
    <div class="modal fade" id="importProjectsModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-upload me-2 text-primary"></i>Import Projects
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        <strong>Import your exported VLAMy projects:</strong> Upload a ZIP file exported from VLAMy or a JSON export file to restore your projects with all annotations and transcriptions.
                    </div>
                    
                    <form id="importProjectsForm" enctype="multipart/form-data">
                        <div class="mb-3">
                            <label class="form-label">Import Format</label>
                            <select class="form-select" id="importFormat">
                                <option value="vlamy" selected>VLAMy Format (ZIP with images + PageXML)</option>
                                <option value="json">JSON Format (metadata only)</option>
                            </select>
                            <div class="form-text">VLAMy format includes images and PageXML files. JSON format contains only metadata and transcriptions.</div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="importFile" class="form-label">Select File to Import</label>
                            <input type="file" class="form-control" id="importFile" accept=".zip,.json" required>
                            <div class="form-text">Select a .zip file for VLAMy format or a .json file for JSON format.</div>
                        </div>
                        
                        <div class="alert alert-warning">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            <strong>Note:</strong> Imported projects will be added to your account. If a project with the same name exists, it will be renamed automatically.
                        </div>
                        
                        <div id="importProgress" style="display: none;">
                            <div class="progress mb-3">
                                <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 100%"></div>
                            </div>
                            <div id="importStatus">Processing import...</div>
                        </div>
                        
                        <div id="importResult" style="display: none;">
                            <div class="alert alert-success">
                                <i class="fas fa-check-circle me-2"></i>
                                <div id="importResultMessage">Import completed successfully!</div>
                            </div>
                            <div id="importSummary"></div>
                        </div>
                        
                        <div id="importError" style="display: none;">
                            <div class="alert alert-danger">
                                <i class="fas fa-exclamation-triangle me-2"></i>
                                <span id="importErrorMessage">Import failed</span>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="startImport()" id="importButton">
                        <i class="fas fa-upload me-2"></i>Start Import
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Alert Container -->
    <div id="alertContainer" class="position-fixed top-0 end-0 p-3" style="z-index: 1060;">
        <!-- Alerts will be added here -->
    </div>

    <!-- JavaScript Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="/static/js/app.js"></script>
</body>
</html> 